##SNPs that are consistently discordant across samples 

**Preparation

```
#!/bin/bash

# Define paths
GATK_PATH="/storage/public/home/2024050455/08.compare/Extract"
CLAIR3_PATH="/storage/public/home/2024050455/08.compare/Sample"

# Define sample arrays
samples_gatk=(
  3DWF22T0036 3DWF22T0070 3DWF22T0240 3DWF22T0415 3DWF22T0549
  3DWFN0018 3DWFP0355 3DWFP0398 3DWFP0413 3DWFQ0177
  3DWFQ0404 3DWFQ0458 3DWFQ0459 3DWFR0017 3DWFR0281
  3DWFS0069 3DWFS0123 3DWFS0137 3DWFS0202 WGWFL0149
)

samples_clair=(
  sample15 sample06 sample12 sample11 sample16
  sample03 sample07 sample20 sample04 sample05
  sample01 sample13 sample02 sample10 sample17
  sample18 sample14 sample09 sample19 sample08
)

# Create output directories
mkdir -p discordant_analysis
mkdir -p temp_files

```

**Step 1: Extract genotype mismatches for each sample pair

```
echo "Step 1: Extracting genotype mismatches for each sample pair..."

# Step 1: Extract genotype mismatches for each sample pair
for i in ${!samples_gatk[@]}; do
  gatk_sample=${samples_gatk[$i]}
  clair_sample=${samples_clair[$i]}
  
  # Define full file paths
  gatk_file="${GATK_PATH}/${gatk_sample}.filtered-DP20-40-GQ30.vcf.gz"
  clair_file="${CLAIR3_PATH}/${clair_sample}_DP10-20_GQ20.vcf.gz"
  
  echo "Processing ${gatk_sample} vs ${clair_sample}..."
  
  # Extract common sites from both files
  bcftools isec \
    -n=2 -w1 \
    ${gatk_file} \
    ${clair_file} \
    -Oz -o temp_files/${gatk_sample}_common.vcf.gz
  
  bcftools isec \
    -n=2 -w2 \
    ${gatk_file} \
    ${clair_file} \
    -Oz -o temp_files/${clair_sample}_common.vcf.gz
  
  # Index the files
  bcftools index temp_files/${gatk_sample}_common.vcf.gz
  bcftools index temp_files/${clair_sample}_common.vcf.gz
  
  # Extract detailed genotype information: CHROM, POS, REF, ALT, GT, GQ, DP
  bcftools query -f '%CHROM\t%POS\t%REF\t%ALT[\t%GT\t%GQ\t%DP]\n' \
    temp_files/${gatk_sample}_common.vcf.gz > temp_files/${gatk_sample}.info
  
  bcftools query -f '%CHROM\t%POS\t%REF\t%ALT[\t%GT\t%GQ\t%DP]\n' \
    temp_files/${clair_sample}_common.vcf.gz > temp_files/${clair_sample}.info
  
  # Compare and extract mismatches with full information
  paste temp_files/${gatk_sample}.info temp_files/${clair_sample}.info | \
    awk -v gs="${gatk_sample}" -v cs="${clair_sample}" \
    'BEGIN{OFS="\t"} 
    $5 != $12 {
      print $1, $2, $3, $4, gs, $5, $6, $7, cs, $12, $13, $14
    }' > discordant_analysis/mismatches_${gatk_sample}_vs_${clair_sample}.txt
done

```

**Step 2: Create a header for the detailed mismatch file

```
echo "Step 2: Aggregating all mismatches..."
# Step 2: Create a header for the detailed mismatch file
echo -e "CHROM\tPOS\tREF\tALT\tGATK_Sample\tGATK_GT\tGATK_GQ\tGATK_DP\tClair3_Sample\tClair3_GT\tClair3_GQ\tClair3_DP" > discordant_analysis/all_genotype_mismatches.txt

# Combine all mismatch files
cat discordant_analysis/mismatches_*.txt >> discordant_analysis/all_genotype_mismatches.txt
```

**Step 3: Calculate per-SNP statistics

```
echo "Step 3: Calculating SNP quality metrics..."

# Step 3: Calculate per-SNP statistics
awk 'NR>1 {key=$1":"$2; count[key]++; samples[key]=samples[key]","$5"_vs_"$9} 
     END {for (k in count) {split(k,pos,":"); print pos[1], pos[2], count[k], samples[k]}}' \
     discordant_analysis/all_genotype_mismatches.txt | \
     sort -k1,1 -k2,2n > temp_files/snp_discordance_counts.txt
```

**Step 4: Create comprehensive SNP quality summary

```
# Step 4: Create comprehensive SNP quality summary
echo "Step 4: Creating comprehensive SNP quality summary..."

# Header for final summary
echo -e "CHROM\tPOS\tREF\tALT\tDiscordance_Count\tTotal_Samples\tDiscordance_Rate\tQuality_Status\tGATK_GT_Distribution\tClair3_GT_Distribution\tAvg_GATK_GQ\tAvg_Clair3_GQ\tAvg_GATK_DP\tAvg_Clair3_DP\tSample_Pairs" > discordant_analysis/SNP_quality_summary.txt

# Process each unique SNP position
awk 'NR>1' discordant_analysis/all_genotype_mismatches.txt | \
  awk '{key=$1":"$2":"$3":"$4; 
        gatk_gt[key][$6]++; 
        clair_gt[key][$10]++; 
        gatk_gq_sum[key]+=$7; 
        clair_gq_sum[key]+=$11; 
        gatk_dp_sum[key]+=$8; 
        clair_dp_sum[key]+=$12; 
        count[key]++; 
        samples[key]=samples[key]";"$5"_vs_"$9
       } 
       END {
         total_samples=20;
         for (k in count) {
           split(k, info, ":");
           chrom=info[1]; pos=info[2]; ref=info[3]; alt=info[4];
           disc_count=count[k];
           disc_rate=disc_count/total_samples;
           
           # Determine quality status
           if (disc_rate >= 0.5) status="BAD";
           else if (disc_rate >= 0.25) status="QUESTIONABLE";
           else status="GOOD";
           
           # Get GT distributions
           gatk_dist=""; clair_dist="";
           for (gt in gatk_gt[k]) gatk_dist=gatk_dist gt":"gatk_gt[k][gt]",";
           for (gt in clair_gt[k]) clair_dist=clair_dist gt":"clair_gt[k][gt]",";
           
           # Calculate averages
           avg_gatk_gq=gatk_gq_sum[k]/disc_count;
           avg_clair_gq=clair_gq_sum[k]/disc_count;
           avg_gatk_dp=gatk_dp_sum[k]/disc_count;
           avg_clair_dp=clair_dp_sum[k]/disc_count;
           
           printf "%s\t%s\t%s\t%s\t%d\t%d\t%.3f\t%s\t%s\t%s\t%.1f\t%.1f\t%.1f\t%.1f\t%s\n", 
                  chrom, pos, ref, alt, disc_count, total_samples, disc_rate, status, 
                  gatk_dist, clair_dist, avg_gatk_gq, avg_clair_gq, avg_gatk_dp, avg_clair_dp, 
                  substr(samples[k],2)
         }
       }' | sort -k1,1 -k2,2n >> discordant_analysis/SNP_quality_summary.txt


```

**Step 5: Creating category-specific files

```
echo "Step 5: Creating category-specific files..."

# Step 5: Split into good, questionable, and bad SNPs
awk 'NR>1 && $8=="BAD"' discordant_analysis/SNP_quality_summary.txt > discordant_analysis/BAD_SNPs.txt
awk 'NR>1 && $8=="QUESTIONABLE"' discordant_analysis/SNP_quality_summary.txt > discordant_analysis/QUESTIONABLE_SNPs.txt
awk 'NR>1 && $8=="GOOD"' discordant_analysis/SNP_quality_summary.txt > discordant_analysis/GOOD_SNPs.txt

# Add headers to category files
sed -i '1i CHROM\tPOS\tREF\tALT\tDiscordance_Count\tTotal_Samples\tDiscordance_Rate\tQuality_Status\tGATK_GT_Distribution\tClair3_GT_Distribution\tAvg_GATK_GQ\tAvg_Clair3_GQ\tAvg_GATK_DP\tAvg_Clair3_DP\tSample_Pairs' discordant_analysis/BAD_SNPs.txt
sed -i '1i CHROM\tPOS\tREF\tALT\tDiscordance_Count\tTotal_Samples\tDiscordance_Rate\tQuality_Status\tGATK_GT_Distribution\tClair3_GT_Distribution\tAvg_GATK_GQ\tAvg_Clair3_GQ\tAvg_GATK_DP\tAvg_Clair3_DP\tSample_Pairs' discordant_analysis/QUESTIONABLE_SNPs.txt
sed -i '1i CHROM\tPOS\tREF\tALT\tDiscordance_Count\tTotal_Samples\tDiscordance_Rate\tQuality_Status\tGATK_GT_Distribution\tClair3_GT_Distribution\tAvg_GATK_GQ\tAvg_Clair3_GQ\tAvg_GATK_DP\tAvg_Clair3_DP\tSample_Pairs' discordant_analysis/GOOD_SNPs.txt

```

**Step 6: Generating summary statistics

```
echo "Step 6: Generating summary statistics..."

# Step 6: Generate overall statistics
cat > discordant_analysis/SUMMARY_STATISTICS.txt << EOF
================================
SNP Quality Analysis Summary
================================

Total unique SNPs analyzed: $(awk 'NR>1' discordant_analysis/SNP_quality_summary.txt | wc -l)

Quality Categories:
-------------------
BAD SNPs (discordance rate >= 50%): $(wc -l < discordant_analysis/BAD_SNPs.txt | awk '{print $1-1}')
QUESTIONABLE SNPs (25% <= rate < 50%): $(wc -l < discordant_analysis/QUESTIONABLE_SNPs.txt | awk '{print $1-1}')
GOOD SNPs (discordance rate < 25%): $(wc -l < discordant_analysis/GOOD_SNPs.txt | awk '{print $1-1}')

Total genotype mismatches: $(awk 'NR>1' discordant_analysis/all_genotype_mismatches.txt | wc -l)

Average discordance rate: $(awk 'NR>1 {sum+=$7; count++} END {print sum/count}' discordant_analysis/SNP_quality_summary.txt)

Files generated:
----------------
1. SNP_quality_summary.txt - Complete summary of all SNPs with quality metrics
2. all_genotype_mismatches.txt - Detailed mismatch information for all sample pairs
3. BAD_SNPs.txt - SNPs with high discordance (>=50%)
4. QUESTIONABLE_SNPs.txt - SNPs with moderate discordance (25-50%)
5. GOOD_SNPs.txt - SNPs with low discordance (<25%)

Top 10 worst SNPs (by discordance count):
------------------------------------------
$(awk 'NR>1' discordant_analysis/SNP_quality_summary.txt | sort -k5,5nr | head -10 | awk '{print $1":"$2, "Count="$5, "Rate="$7}')
EOF


```